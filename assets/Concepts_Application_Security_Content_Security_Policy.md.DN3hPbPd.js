import{A as e,d as t,m as n}from"./chunks/runtime-core.esm-bundler.BXAIOQQS.js";import{t as r}from"./chunks/plugin-vue_export-helper.CtN8rQnz.js";const i=JSON.parse(`{"title":"Content Security Policy","description":"Content Security Policy","frontmatter":{"title":"Content Security Policy","description":"Content Security Policy"},"headers":[],"relativePath":"Concepts/Application_Security/Content_Security_Policy.md","filePath":"Concepts/Application_Security/Content_Security_Policy.md","lastUpdated":1756574703000}`);var a={name:`Concepts/Application_Security/Content_Security_Policy.md`};function o(r,i,a,o,s,c){return e(),t(`div`,null,[...i[0]||=[n(`<h1 id="content-security-policy-csp" tabindex="-1">Content Security Policy (CSP) <a class="header-anchor" href="#content-security-policy-csp" aria-label="Permalink to “Content Security Policy (CSP)”">​</a></h1><p>CSP provides additional layer of protection by enforcing loading of resources (scripts, images, etc.) from trusted locations</p><ul><li>It&#39;s very effective against XSS, Clickjacking etc.</li><li>Visibility on attacks on app using CSP reporting directive</li><li>Options to deliver CSP: <ul><li><code>Content-Security-Policy</code> header is preferred technique</li><li><code>&lt;meta&gt;</code> HTML element with <code>http-equiv</code> with attribute set to <code>Content-Security-Policy</code></li><li><code>Content-Security-Policy-Report-Only</code> header used only for monitoring and not enforcing</li></ul></li></ul><p>Headers that can be used:</p><ul><li><code>Content-Security-Policy</code>: yes</li><li><code>Content-Security-Policy-Report-Only</code>: !</li><li><code>X-Content-Security-Policy</code>: no</li><li><code>X-WebKit-CSP</code>: no</li></ul><p><em>Example:</em></p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">meta</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;">  http-equiv</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">Content-Security-Policy</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;">  content</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">        default-src &#39;self&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">        font-src &#39;self&#39; https://fonts.gstatic.com/;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">        style-src-elem &#39;self&#39; googleapis.com;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">        &quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">/&gt;</span></span></code></pre></div><h2 id="csp-directives" tabindex="-1">CSP Directives <a class="header-anchor" href="#csp-directives" aria-label="Permalink to “CSP Directives”">​</a></h2><p>CSP - fine grain control set</p><ul><li><p><strong>Fetch</strong>: Informs browser of locations to trust and load resources from Eg.: <code>script-src</code>, <code>object-src</code></p></li><li><p><strong>Document</strong>: Informs properties of documents to which policies will apply. Eg.: <code>base-url</code>, <code>sandbox</code></p></li><li><p><strong>Navigation</strong>: Informs about the location that the document can navigate to. Eg.: <code>frame-ancestors</code></p></li><li><p><strong>Reporting</strong>: Delivers violations to specified location. Eg.: <code>report-to</code>, <code>report-uri</code></p></li></ul><p>Special directives:</p><table tabindex="0"><thead><tr><th>Name</th><th>Purpose</th></tr></thead><tbody><tr><td><code>none</code></td><td>Strict. No resources allowed.</td></tr><tr><td><code>self</code></td><td>Strict. Only resources from same origin.</td></tr><tr><td><code>unsafe-inline</code></td><td>Weak. Allows scripts in HTML.</td></tr><tr><td><code>unsafe-eval</code></td><td>Weak. Allows <code>eval()</code> functions in scripts.</td></tr><tr><td><code>strict-dynamic</code></td><td>Strong (if used correctly). Allows trust propagation scripts.</td></tr></tbody></table><h2 id="basic-csp-policy" tabindex="-1">Basic CSP Policy <a class="header-anchor" href="#basic-csp-policy" aria-label="Permalink to “Basic CSP Policy”">​</a></h2><p>Basic policy with good security has the following requirements:</p><ul><li><p>All resources are hosted by the same domain of the document</p></li><li><p>There are no inlines or evals for scripts and style resources:</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> default-src &#39;self&#39;;</span></span></code></pre></div></li><li><p><strong>Stricter</strong>: Only allow images, scripts, AJAX and CSS from same origin. (No frame, object, media, etc.)</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> default-src &#39;none&#39;; script-src &#39;self&#39;; connect-src &#39;self&#39;; img-src &#39;self&#39;; style-src &#39;self&#39;;</span></span></code></pre></div></li></ul><p>Order of priority: <code>default-src</code> --&gt; <code>script-src</code> --&gt; <code>script-src-elem</code> | <code>script-src-attr</code></p><h2 id="locking-down-javascript" tabindex="-1">Locking Down JavaScript <a class="header-anchor" href="#locking-down-javascript" aria-label="Permalink to “Locking Down JavaScript”">​</a></h2><ol><li><p><strong>Hash Method</strong>:</p><ul><li><p>Calculate the hash of the script or script file</p></li><li><p>Following changes to application is required:</p></li><li><p>Refactor any markup with inline event handlers (e.g. <code>onclick</code>) and JavaScript: URIs</p></li><li><p>Move all scripts (movable) from inline to external JS files</p></li><li><p>Add input validation for any user inputs and encoding before writing into DOM</p></li></ul><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#DBD7CAEE;">script-src &#39;sha2-d24982a62c99c55d38cf05efe943324c95a342b019b6a5bc136dc865&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#758575DD;">&lt;!-- chrome calculates for us --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">console</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">this will work</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> src</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">https://...</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span></code></pre></div></li><li><p><strong>Nonce</strong>:</p><ul><li><p>Nonce is arbitrary number that can be used just once</p></li><li><p>Nonce is composed of <code>base64</code> values</p></li><li><p>Nonce attributes are added to script tags</p></li><li><p>Nonce is verified against the nonce sent in the CSP header</p></li><li><p>Following changes to application is required:</p><ul><li>Add nonce attribute to all trusted <code>&lt;script&gt;</code> elements</li><li>For every page load, generate a new nonce and use that in CSP header</li></ul></li></ul><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#DBD7CAEE;">script-src &#39;nonce-SecureRandomValue&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> nonce</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">SecureRandomValue</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">console</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">this will work</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> nonce</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">SecureRandomValue</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> src</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">https://...</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span></code></pre></div></li></ol><p>For dynamic JS:</p><ul><li>Some JS/Framework might add/create scripts dynamically and append to DOM</li><li>If scripts are appended by trusted (nonce) scripts, then allow them</li></ul><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#DBD7CAEE;">script-src &#39;nonce-SecureRandomValue&#39; &#39;strict-dynamic&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#758575DD;">&lt;!-- this is allowed --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> nonce</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">SecureRandomValue</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#CB7676;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;"> s</span><span style="--shiki-light:#D73A49;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;"> document</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#80A665;">createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">script</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">  s</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">src</span><span style="--shiki-light:#D73A49;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">some.com/some.js</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">  document</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#80A665;">appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#BD976A;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#758575DD;">&lt;!-- this is blocked --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#BD976A;"> src</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;">some.com/some.js</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#666666;">&gt;</span></span></code></pre></div><h2 id="preventing-clickjacking" tabindex="-1">Preventing Clickjacking <a class="header-anchor" href="#preventing-clickjacking" aria-label="Permalink to “Preventing Clickjacking”">​</a></h2><p>A companion to <code>X-Frame-Options</code>:</p><ul><li><p>Protect page from being framed by other sites</p></li><li><p>Prevent all framing of your content:</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> frame-ancestors &#39;none&#39;;</span></span></code></pre></div></li><li><p>Allow framing for site itself:</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> frame-ancestors &#39;self&#39;;</span></span></code></pre></div></li><li><p>Allow framing for trusted domains:</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> frame-ancestors &#39;trusted.com&#39;;</span></span></code></pre></div></li></ul><h2 id="versions" tabindex="-1">Versions <a class="header-anchor" href="#versions" aria-label="Permalink to “Versions”">​</a></h2><p>CSP3</p><h2 id="policy-injection" tabindex="-1">Policy Injection <a class="header-anchor" href="#policy-injection" aria-label="Permalink to “Policy Injection”">​</a></h2><ul><li><p>New directive <code>script-src-elem</code> allows you to control just script blocks</p></li><li><p>This allows event handlers but blocks script elements:</p><div class="language-http"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes github-light vitesse-dark" style="--shiki-light:#24292e;--shiki-dark:#dbd7caee;--shiki-light-bg:#fff;--shiki-dark-bg:#121212;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#4D9375;">Content-Security-Policy</span><span style="--shiki-light:#D73A49;--shiki-dark:#4D9375;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#C98A7D;"> script-src-elem &#39;none&#39;; script-src-attr &#39;unsafe-inline&#39;;</span></span></code></pre></div></li><li><p>CSP bypass is possible provided you have policy injection flaw</p></li><li><p>This directive will overwrite existing <code>script-src</code> directives</p></li></ul><p>JSONP problem:</p><ul><li>Allowlist an origin/path hosting a JSONP</li><li>JS execution is allowed. Depends on JSONP endpoint</li><li>CDN typically have numerous exposed JSONP endpoint</li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to “Conclusion”">​</a></h2><ul><li>CSP is very effective with Nonce and/or SHA</li><li>Beware of using <code>strict-dynamic</code>. Only on trusted scripts/frameworks</li><li>Start with report only CSP header</li><li>Beware of Unvalidated redirects, JSONP endpoints or Header injection</li><li>Not a substitute for XSS protection</li></ul>`,32)]])}var s=r(a,[[`render`,o]]);export{i as __pageData,s as default};